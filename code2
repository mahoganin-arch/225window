//@version=6
strategy("æ—¥çµŒ225 çª“åŸ‹ã‚ãƒ»åè»¢ãƒŠãƒ³ãƒ”ãƒ³æˆ¦ç•¥ v4.0", 
         overlay=true,
         initial_capital=500000,
         default_qty_type=strategy.fixed,
         default_qty_value=1,
         commission_type=strategy.commission.cash_per_order,
         commission_value=352,
         slippage=0,
         calc_on_every_tick=true,
         process_orders_on_close=false)

// =====================================
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
// =====================================

// çª“åŸ‹ã‚ãƒŠãƒ³ãƒ”ãƒ³è¨­å®š
gap_group = "ğŸ“ˆ çª“åŸ‹ã‚æˆ¦ç•¥"
gap_enable = input.bool(true, "çª“åŸ‹ã‚æˆ¦ç•¥ã‚’æœ‰åŠ¹åŒ–", group=gap_group)
gap_num_entries = input.int(3, "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›æ•°", minval=1, maxval=3, group=gap_group)
gap_interval = input.int(40, "ã‚¨ãƒ³ãƒˆãƒªãƒ¼é–“éš”ï¼ˆå††ï¼‰", minval=10, maxval=100, group=gap_group)
gap_init_threshold = input.int(50, "åˆå›é–¾å€¤ï¼ˆå††ï¼‰", minval=30, maxval=200, group=gap_group)
gap_stop_loss = input.int(40, "æåˆ‡ã‚Šå¹…ï¼ˆå††ï¼‰", minval=20, maxval=300, group=gap_group)
gap_profit_offset = input.int(-10, "åˆ©ç¢ºã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆå††ï¼‰", minval=-50, maxval=50, group=gap_group, tooltip="ãƒã‚¸ã‚·ãƒ§ãƒ³ä¿æœ‰æ™‚ã®åˆ©ç¢ºä¾¡æ ¼ã€‚è² ã®å€¤=çª“åŸ‹ã‚å‰ã«åˆ©ç¢º")
gap_fill_threshold = input.int(0, "çª“åŸ‹ã‚å®Œäº†é–¾å€¤ï¼ˆå††ï¼‰", minval=-50, maxval=50, group=gap_group, tooltip="ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ã«çª“ãŒåŸ‹ã¾ã£ãŸã¨åˆ¤å®šã™ã‚‹åŸºæº–ã€‚è² ã®å€¤=çª“åŸ‹ã‚å‰")
gap_reentry_mode = input.int(1, "å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰", minval=0, maxval=2, group=gap_group, tooltip="0=ç¦æ­¢ / 1=æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ã®ã¿ / 2=å¸¸ã«å¯èƒ½")
allow_window_direction_change = input.bool(false, "çª“æ–¹å‘å¤‰æ›´ã‚’è¨±å¯", group=gap_group, tooltip="ONã®å ´åˆã€çª“ã®æ–¹å‘ãŒé€”ä¸­ã§å¤‰ã‚ã‚‹ã“ã¨ã‚’è¨±å¯")

// åè»¢ãƒŠãƒ³ãƒ”ãƒ³è¨­å®š
rev_group = "ğŸ”„ åè»¢æˆ¦ç•¥"
rev_enable = input.bool(true, "åè»¢æˆ¦ç•¥ã‚’æœ‰åŠ¹åŒ–", group=rev_group)
rev_num_entries = input.int(3, "ã‚¨ãƒ³ãƒˆãƒªãƒ¼å›æ•°", minval=1, maxval=3, group=rev_group)
rev_morning_interval = input.int(25, "æœã®é–“éš”ï¼ˆå††ï¼‰", minval=10, maxval=100, group=rev_group)
rev_morning_profit = input.int(80, "æœã®åˆ©ç¢ºå¹…ï¼ˆå††ï¼‰", minval=10, maxval=200, group=rev_group)
rev_morning_stop = input.int(140, "æœã®æåˆ‡ã‚Šå¹…ï¼ˆå††ï¼‰", minval=30, maxval=300, group=rev_group)
rev_evening_interval = input.int(15, "å¤•æ–¹ã®é–“éš”ï¼ˆå††ï¼‰", minval=10, maxval=100, group=rev_group)
rev_evening_profit = input.int(50, "å¤•æ–¹ã®åˆ©ç¢ºå¹…ï¼ˆå††ï¼‰", minval=10, maxval=200, group=rev_group)
rev_evening_stop = input.int(40, "å¤•æ–¹ã®æåˆ‡ã‚Šå¹…ï¼ˆå††ï¼‰", minval=30, maxval=300, group=rev_group)
rev_force_close_minutes = input.int(30, "åè»¢å¼·åˆ¶æ±ºæ¸ˆï¼ˆåˆ†ï¼‰", minval=10, maxval=60, group=rev_group)

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
filter_group = "ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼"
skip_monday_morning = input.bool(true, "æœˆæ›œæœã‚’ã‚¹ã‚­ãƒƒãƒ—", group=filter_group)
skip_noon_reversal = input.bool(true, "æ˜¼ã®åè»¢ã‚’ã‚¹ã‚­ãƒƒãƒ—", group=filter_group)
min_gap_size = input.int(50, "æœ€å°çª“ã‚µã‚¤ã‚ºï¼ˆå††ï¼‰", minval=30, maxval=100, group=filter_group)
entry_morning_only = input.bool(false, "æœã®ã¿ã‚¨ãƒ³ãƒˆãƒªãƒ¼", group=filter_group)
entry_noon_only = input.bool(false, "æ˜¼ã®ã¿ã‚¨ãƒ³ãƒˆãƒªãƒ¼", group=filter_group)
entry_evening_only = input.bool(false, "å¤•æ–¹ã®ã¿ã‚¨ãƒ³ãƒˆãƒªãƒ¼", group=filter_group)

// è¡¨ç¤ºè¨­å®š
display_group = "ğŸ¨ è¡¨ç¤ºè¨­å®š"
show_lines = input.bool(true, "ãƒ©ã‚¤ãƒ³è¡¨ç¤º", group=display_group)
show_labels = input.bool(true, "ãƒ©ãƒ™ãƒ«è¡¨ç¤º", group=display_group)
show_background = input.bool(true, "æ™‚é–“å¸¯ã®èƒŒæ™¯è‰²", group=display_group)

// =====================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// =====================================

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
var float base_price = na
var bool in_stagnation = false
var bool can_entry = false
var int stagnation_period = 0
var bool is_monday_morning = false

// çª“ã®æ–¹å‘åˆ¤å®šï¼ˆçª“åŸ‹ã‚ã¨åè»¢ã§å…±æœ‰ï¼‰
var bool gap_entered_this_session = false
var bool is_up_window = false
var bool gap_filled = false
var int gap_filled_time = 0

// çª“åŸ‹ã‚åˆ¶å¾¡ãƒ•ãƒ©ã‚°
var bool gap_trade_completed = false
var bool gap_ever_entered = false

// çª“åŸ‹ã‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®æ¨™ä¾¡æ ¼
var float gap_target_1 = na
var float gap_target_2 = na
var float gap_target_3 = na

// çª“åŸ‹ã‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Ÿè¡Œä¾¡æ ¼
var float gap_entry_1 = na
var float gap_entry_2 = na
var float gap_entry_3 = na
var int gap_position_count = 0

// çª“åŸ‹ã‚æ±ºæ¸ˆä¾¡æ ¼
var float gap_profit_price = na
var float gap_stop_price = na

// åè»¢åˆ¶å¾¡ãƒ•ãƒ©ã‚°
var bool reversal_entered_this_session = false
var bool reversal_trade_completed = false
var bool rev_is_morning = false

// åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®æ¨™ä¾¡æ ¼
var float rev_target_1 = na
var float rev_target_2 = na
var float rev_target_3 = na

// åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Ÿè¡Œä¾¡æ ¼
var float rev_entry_1 = na
var float rev_entry_2 = na
var float rev_entry_3 = na
var int rev_position_count = 0
var int rev_start_time = 0
var float rev_base_price = na

// åè»¢æ±ºæ¸ˆä¾¡æ ¼
var float rev_profit_target = na
var float rev_stop_target = na

// è¡¨ç¤ºåˆ¶å¾¡
var int last_label_period = 0

// =====================================
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
// =====================================

get_jst_hour() =>
    hour(time, "GMT+9")

get_jst_minute() =>
    minute(time, "GMT+9")

get_jst_dayofweek() =>
    dayofweek(time, "GMT+9")

is_time_jst(h, m) =>
    get_jst_hour() == h and get_jst_minute() == m

is_monday_jst() =>
    get_jst_dayofweek() == 2

// æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¤å®š
is_entry_allowed_by_time_filter() =>
    if entry_morning_only
        stagnation_period == 1
    else if entry_noon_only
        stagnation_period == 2
    else if entry_evening_only
        stagnation_period == 3
    else
        true  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãªã—

// å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç¦æ­¢æ™‚åˆ»ãƒã‚§ãƒƒã‚¯
is_reentry_time_allowed() =>
    if stagnation_period == 1
        get_jst_hour() < 9
    else if stagnation_period == 2
        get_jst_hour() < 12 or (get_jst_hour() == 12 and get_jst_minute() < 30)
    else if stagnation_period == 3
        get_jst_hour() < 17
    else
        false

// =====================================
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
// =====================================

// æœã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: 7:00
if is_time_jst(7, 0) and na(base_price)
    base_price := close[1]
    in_stagnation := true
    can_entry := false
    stagnation_period := 1
    is_monday_morning := is_monday_jst()
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// æœã‚¨ãƒ³ãƒˆãƒªãƒ¼é–‹å§‹: 8:30
if is_time_jst(8, 30) and stagnation_period == 1
    can_entry := true

// æœã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†: 10:45
if is_time_jst(10, 45) and stagnation_period == 1
    if strategy.position_size != 0
        strategy.close_all(comment="æœå¼·åˆ¶æ±ºæ¸ˆ")
        alert("â°æœã‚»ãƒƒã‚·ãƒ§ãƒ³å¼·åˆ¶æ±ºæ¸ˆ", alert.freq_once_per_bar)
    
    base_price := na
    in_stagnation := false
    can_entry := false
    stagnation_period := 0
    is_monday_morning := false
    last_label_period := 0
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// æ˜¼ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: 11:30
if is_time_jst(11, 30) and na(base_price)
    base_price := close[1]
    in_stagnation := true
    can_entry := true
    stagnation_period := 2
    is_monday_morning := false
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// æ˜¼ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†: 14:30
if is_time_jst(14, 30) and stagnation_period == 2
    if strategy.position_size != 0
        strategy.close_all(comment="æ˜¼å¼·åˆ¶æ±ºæ¸ˆ")
        alert("â°æ˜¼ã‚»ãƒƒã‚·ãƒ§ãƒ³å¼·åˆ¶æ±ºæ¸ˆ", alert.freq_once_per_bar)
    
    base_price := na
    in_stagnation := false
    can_entry := false
    stagnation_period := 0
    is_monday_morning := false
    last_label_period := 0
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// å¤•æ–¹ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: 15:45
if is_time_jst(15, 45) and na(base_price)
    base_price := close[1]
    in_stagnation := true
    can_entry := true
    stagnation_period := 3
    is_monday_morning := false
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// å¤•æ–¹ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†: 19:00
if is_time_jst(19, 0) and stagnation_period == 3
    if strategy.position_size != 0
        strategy.close_all(comment="å¤•æ–¹å¼·åˆ¶æ±ºæ¸ˆ")
        alert("â°å¤•æ–¹ã‚»ãƒƒã‚·ãƒ§ãƒ³å¼·åˆ¶æ±ºæ¸ˆ", alert.freq_once_per_bar)
    
    base_price := na
    in_stagnation := false
    can_entry := false
    stagnation_period := 0
    is_monday_morning := false
    last_label_period := 0
    
    // å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
    gap_entry_1 := na
    gap_entry_2 := na
    gap_entry_3 := na
    gap_target_1 := na
    gap_target_2 := na
    gap_target_3 := na
    gap_position_count := 0
    is_up_window := false
    gap_filled := false
    gap_filled_time := 0
    gap_profit_price := na
    gap_stop_price := na
    gap_entered_this_session := false
    gap_trade_completed := false
    gap_ever_entered := false
    rev_entry_1 := na
    rev_entry_2 := na
    rev_entry_3 := na
    rev_target_1 := na
    rev_target_2 := na
    rev_target_3 := na
    rev_position_count := 0
    rev_start_time := 0
    rev_base_price := na
    rev_profit_target := na
    rev_stop_target := na
    reversal_entered_this_session := false
    reversal_trade_completed := false

// =====================================
// çª“åŸ‹ã‚ã®æ±ºæ¸ˆç®¡ç†
// =====================================

if gap_position_count > 0 and strategy.position_size != 0 and not na(gap_profit_price) and not na(gap_stop_price)
    // åˆ©ç¢ºåˆ¤å®š
    if is_up_window and low <= gap_profit_price and not gap_filled
        strategy.close_all(comment="çª“åŸ‹ã‚åˆ©ç¢º")
        alert("âœ…çª“åŸ‹ã‚åˆ©ç¢º: " + str.tostring(gap_profit_price) + "å††", alert.freq_once_per_bar)
        
        // åè»¢ç”¨ã®åŸºæº–ä¾¡æ ¼ã‚’è¨˜éŒ²
        if rev_enable
            rev_base_price := base_price
            rev_start_time := time
            rev_is_morning := stagnation_period == 1
        
        // çª“åŸ‹ã‚å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
        gap_entry_1 := na
        gap_entry_2 := na
        gap_entry_3 := na
        gap_target_1 := na
        gap_target_2 := na
        gap_target_3 := na
        gap_position_count := 0
        gap_profit_price := na
        gap_stop_price := na
        gap_trade_completed := true
        gap_filled := true
        gap_filled_time := time
    
    else if not is_up_window and high >= gap_profit_price and not gap_filled
        strategy.close_all(comment="çª“åŸ‹ã‚åˆ©ç¢º")
        alert("âœ…çª“åŸ‹ã‚åˆ©ç¢º: " + str.tostring(gap_profit_price) + "å††", alert.freq_once_per_bar)
        
        // åè»¢ç”¨ã®åŸºæº–ä¾¡æ ¼ã‚’è¨˜éŒ²
        if rev_enable
            rev_base_price := base_price
            rev_start_time := time
            rev_is_morning := stagnation_period == 1
        
        // çª“åŸ‹ã‚å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
        gap_entry_1 := na
        gap_entry_2 := na
        gap_entry_3 := na
        gap_target_1 := na
        gap_target_2 := na
        gap_target_3 := na
        gap_position_count := 0
        gap_profit_price := na
        gap_stop_price := na
        gap_trade_completed := true
        gap_filled := true
        gap_filled_time := time
    
    // æåˆ‡ã‚Šåˆ¤å®š
    else if is_up_window and high >= gap_stop_price
        strategy.close_all(comment="çª“åŸ‹ã‚æåˆ‡ã‚Š")
        alert("âŒçª“åŸ‹ã‚æåˆ‡ã‚Š: " + str.tostring(gap_stop_price) + "å††", alert.freq_once_per_bar)
        gap_entry_1 := na
        gap_entry_2 := na
        gap_entry_3 := na
        gap_target_1 := na
        gap_target_2 := na
        gap_target_3 := na
        gap_position_count := 0
        gap_profit_price := na
        gap_stop_price := na
        gap_trade_completed := true
        
        // åè»¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        rev_base_price := na
        reversal_entered_this_session := false
        reversal_trade_completed := true
    
    else if not is_up_window and low <= gap_stop_price
        strategy.close_all(comment="çª“åŸ‹ã‚æåˆ‡ã‚Š")
        alert("âŒçª“åŸ‹ã‚æåˆ‡ã‚Š: " + str.tostring(gap_stop_price) + "å††", alert.freq_once_per_bar)
        gap_entry_1 := na
        gap_entry_2 := na
        gap_entry_3 := na
        gap_target_1 := na
        gap_target_2 := na
        gap_target_3 := na
        gap_position_count := 0
        gap_profit_price := na
        gap_stop_price := na
        gap_trade_completed := true
        
        // åè»¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        rev_base_price := na
        reversal_entered_this_session := false
        reversal_trade_completed := true

// =====================================
// çª“ã®æ–¹å‘åˆ¤å®šï¼ˆçª“åŸ‹ã‚ã¨åè»¢ã§å…±æœ‰ï¼‰
// =====================================

if in_stagnation and can_entry and not na(base_price) and (gap_enable or rev_enable) and is_entry_allowed_by_time_filter()
    // æœˆæ›œæœã‚¹ã‚­ãƒƒãƒ—åˆ¤å®š
    skip_entry = skip_monday_morning and is_monday_morning
    
    if not skip_entry
        // çª“æ–¹å‘ã®æ¤œå‡ºã¾ãŸã¯å¤‰æ›´
        should_detect_window = false
        
        if allow_window_direction_change
            // æ–¹å‘å¤‰æ›´è¨±å¯: æ¯ãƒãƒ¼å†è©•ä¾¡
            if not gap_entered_this_session or gap_position_count == 0
                should_detect_window := true
        else
            // æ–¹å‘å¤‰æ›´ç¦æ­¢: åˆå›ã®ã¿
            if not gap_entered_this_session
                should_detect_window := true
        
        if should_detect_window
            gap_up = high - base_price
            gap_down = base_price - low
            
            if gap_up >= min_gap_size and gap_up > gap_down
                // æ–¹å‘ãŒå¤‰ã‚ã£ãŸå ´åˆã€ãƒªã‚»ãƒƒãƒˆ
                if gap_entered_this_session and not is_up_window
                    gap_target_1 := na
                    gap_target_2 := na
                    gap_target_3 := na
                    gap_entry_1 := na
                    gap_entry_2 := na
                    gap_entry_3 := na
                    gap_position_count := 0
                    gap_filled := false
                    gap_trade_completed := false
                
                is_up_window := true
                gap_entered_this_session := true
                
                // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®æ¨™ä¾¡æ ¼ã‚’è¨ˆç®—
                gap_target_1 := base_price + gap_init_threshold
                gap_target_2 := base_price + gap_init_threshold + gap_interval
                gap_target_3 := base_price + gap_init_threshold + gap_interval * 2
                
                // æåˆ‡ã‚Šè¶…ãˆãƒã‚§ãƒƒã‚¯
                final_target = gap_target_3
                check_stop = final_target + gap_stop_loss
                if high >= check_stop
                    gap_trade_completed := true
                    gap_target_1 := na
                    gap_target_2 := na
                    gap_target_3 := na
            
            else if gap_down >= min_gap_size and gap_down > gap_up
                // æ–¹å‘ãŒå¤‰ã‚ã£ãŸå ´åˆã€ãƒªã‚»ãƒƒãƒˆ
                if gap_entered_this_session and is_up_window
                    gap_target_1 := na
                    gap_target_2 := na
                    gap_target_3 := na
                    gap_entry_1 := na
                    gap_entry_2 := na
                    gap_entry_3 := na
                    gap_position_count := 0
                    gap_filled := false
                    gap_trade_completed := false
                
                is_up_window := false
                gap_entered_this_session := true
                
                // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®æ¨™ä¾¡æ ¼ã‚’è¨ˆç®—
                gap_target_1 := base_price - gap_init_threshold
                gap_target_2 := base_price - gap_init_threshold - gap_interval
                gap_target_3 := base_price - gap_init_threshold - gap_interval * 2
                
                // æåˆ‡ã‚Šè¶…ãˆãƒã‚§ãƒƒã‚¯
                final_target = gap_target_3
                check_stop = final_target - gap_stop_loss
                if low <= check_stop
                    gap_trade_completed := true
                    gap_target_1 := na
                    gap_target_2 := na
                    gap_target_3 := na

// =====================================
// çª“åŸ‹ã‚å®Œäº†åˆ¤å®šï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
// =====================================

if in_stagnation and not na(base_price) and gap_entered_this_session and not gap_filled and gap_position_count == 0
    // ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—ã§çª“åŸ‹ã‚ä¾¡æ ¼ã«åˆ°é”ã—ãŸå ´åˆï¼ˆåˆ©ç¢ºã‚ªãƒ•ã‚»ãƒƒãƒˆã¨åŒã˜è¨ˆç®—å¼ï¼‰
    if is_up_window and low <= (base_price - gap_fill_threshold)
        gap_filled := true
        gap_filled_time := time
        
        // åè»¢ç”¨ã®åŸºæº–ä¾¡æ ¼ã‚’è¨˜éŒ²
        if rev_enable
            rev_base_price := base_price
            rev_start_time := 0  // åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼1ã§è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒªã‚»ãƒƒãƒˆ
            rev_is_morning := stagnation_period == 1
    
    else if not is_up_window and high >= (base_price + gap_fill_threshold)
        gap_filled := true
        gap_filled_time := time
        
        // åè»¢ç”¨ã®åŸºæº–ä¾¡æ ¼ã‚’è¨˜éŒ²
        if rev_enable
            rev_base_price := base_price
            rev_start_time := 0  // åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼1ã§è¨­å®šã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ãƒªã‚»ãƒƒãƒˆ
            rev_is_morning := stagnation_period == 1

// =====================================
// å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤å®š
// =====================================

// çª“åŸ‹ã‚å®Œäº†å¾Œã®å†ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆ¤å®š
if gap_filled and not gap_trade_completed and gap_reentry_mode > 0 and is_reentry_time_allowed()
    allow_reentry = false
    
    if gap_reentry_mode == 1
        // ãƒ¢ãƒ¼ãƒ‰1: æœªã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ã®ã¿
        if not gap_ever_entered
            allow_reentry := true
    else if gap_reentry_mode == 2
        // ãƒ¢ãƒ¼ãƒ‰2: å¸¸ã«å¯èƒ½
        allow_reentry := true
    
    if allow_reentry
        // å†ã³åˆå›é–¾å€¤ã«åˆ°é”ã—ãŸã‹ç¢ºèª
        if is_up_window and high >= gap_target_1
            gap_filled := false
            gap_trade_completed := false
        else if not is_up_window and low <= gap_target_1
            gap_filled := false
            gap_trade_completed := false

// =====================================
// çª“åŸ‹ã‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼
// =====================================

if gap_enable and gap_entered_this_session and not na(gap_target_1) and not gap_trade_completed and not gap_filled
    // ä¸Šçª“ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆï¼‰
    if is_up_window
        // åˆ©ç¢ºãƒ»æåˆ‡ã‚Šä¾¡æ ¼ã‚’è¨­å®šï¼ˆåˆå›ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ï¼‰
        if na(gap_profit_price)
            gap_profit_price := base_price - gap_profit_offset
            gap_stop_price := gap_target_3 + gap_stop_loss
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼1
        if na(gap_entry_1) and high >= gap_target_1
            strategy.entry("gap_short_1", strategy.short, qty=1, comment="çª“åŸ‹ã‚1")
            gap_entry_1 := gap_target_1
            gap_position_count := gap_position_count + 1
            gap_ever_entered := true
            alert("ğŸ”½çª“åŸ‹ã‚ã‚·ãƒ§ãƒ¼ãƒˆ1: " + str.tostring(gap_target_1) + "å†† (åŸºæº–" + str.tostring(base_price) + "å††)", alert.freq_once_per_bar)
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼2
        if gap_num_entries >= 2 and na(gap_entry_2) and high >= gap_target_2
            strategy.entry("gap_short_2", strategy.short, qty=1, comment="çª“åŸ‹ã‚2")
            gap_entry_2 := gap_target_2
            gap_position_count := gap_position_count + 1
            alert("ğŸ”½çª“åŸ‹ã‚ã‚·ãƒ§ãƒ¼ãƒˆ2: " + str.tostring(gap_target_2) + "å††", alert.freq_once_per_bar)
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼3
        if gap_num_entries >= 3 and na(gap_entry_3) and high >= gap_target_3
            strategy.entry("gap_short_3", strategy.short, qty=1, comment="çª“åŸ‹ã‚3")
            gap_entry_3 := gap_target_3
            gap_position_count := gap_position_count + 1
            alert("ğŸ”½çª“åŸ‹ã‚ã‚·ãƒ§ãƒ¼ãƒˆ3: " + str.tostring(gap_target_3) + "å††", alert.freq_once_per_bar)
    
    // ä¸‹çª“ï¼ˆãƒ­ãƒ³ã‚°ï¼‰
    else
        // åˆ©ç¢ºãƒ»æåˆ‡ã‚Šä¾¡æ ¼ã‚’è¨­å®šï¼ˆåˆå›ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ï¼‰
        if na(gap_profit_price)
            gap_profit_price := base_price + gap_profit_offset
            gap_stop_price := gap_target_3 - gap_stop_loss
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼1
        if na(gap_entry_1) and low <= gap_target_1
            strategy.entry("gap_long_1", strategy.long, qty=1, comment="çª“åŸ‹ã‚1")
            gap_entry_1 := gap_target_1
            gap_position_count := gap_position_count + 1
            gap_ever_entered := true
            alert("ğŸ”¼çª“åŸ‹ã‚ãƒ­ãƒ³ã‚°1: " + str.tostring(gap_target_1) + "å†† (åŸºæº–" + str.tostring(base_price) + "å††)", alert.freq_once_per_bar)
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼2
        if gap_num_entries >= 2 and na(gap_entry_2) and low <= gap_target_2
            strategy.entry("gap_long_2", strategy.long, qty=1, comment="çª“åŸ‹ã‚2")
            gap_entry_2 := gap_target_2
            gap_position_count := gap_position_count + 1
            alert("ğŸ”¼çª“åŸ‹ã‚ãƒ­ãƒ³ã‚°2: " + str.tostring(gap_target_2) + "å††", alert.freq_once_per_bar)
        
        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼3
        if gap_num_entries >= 3 and na(gap_entry_3) and low <= gap_target_3
            strategy.entry("gap_long_3", strategy.long, qty=1, comment="çª“åŸ‹ã‚3")
            gap_entry_3 := gap_target_3
            gap_position_count := gap_position_count + 1
            alert("ğŸ”¼çª“åŸ‹ã‚ãƒ­ãƒ³ã‚°3: " + str.tostring(gap_target_3) + "å††", alert.freq_once_per_bar)

// =====================================
// åè»¢æˆ¦ç•¥ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼
// =====================================

// åè»¢é–‹å§‹åˆ¤å®šï¼ˆçª“åŸ‹ã‚å®Œäº†å¾Œã€ãƒã‚¸ã‚·ãƒ§ãƒ³ãªã—ã®çŠ¶æ…‹ã§ï¼‰
if gap_filled and rev_enable and not na(rev_base_price) and not reversal_entered_this_session and not reversal_trade_completed and rev_position_count == 0 and strategy.position_size == 0 and is_entry_allowed_by_time_filter()
    // æ˜¼ã®åè»¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
    skip_reversal = skip_noon_reversal and stagnation_period == 2
    // æœˆæ›œæœã‚’ã‚¹ã‚­ãƒƒãƒ—
    skip_reversal := skip_reversal or (skip_monday_morning and is_monday_morning)
    
    if not skip_reversal
        reversal_entered_this_session := true
        
        // æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
        rev_interval = rev_is_morning ? rev_morning_interval : rev_evening_interval
        rev_profit = rev_is_morning ? rev_morning_profit : rev_evening_profit
        rev_stop = rev_is_morning ? rev_morning_stop : rev_evening_stop
        
        // åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®æ¨™ä¾¡æ ¼ã‚’1å›ã ã‘è¨ˆç®—
        if is_up_window
            // ä¸Šçª“åŸ‹ã‚å¾Œ â†’ ãƒ­ãƒ³ã‚°
            rev_target_1 := rev_base_price
            rev_target_2 := rev_base_price - rev_interval
            rev_target_3 := rev_base_price - rev_interval * 2
            
            // åˆ©ç¢ºãƒ»æåˆ‡ã‚Šä¾¡æ ¼ã‚’è¨­å®š
            avg_price = (rev_target_1 + rev_target_2 + rev_target_3) / 3
            rev_profit_target := avg_price + rev_profit
            rev_stop_target := rev_target_3 - rev_stop
        else
            // ä¸‹çª“åŸ‹ã‚å¾Œ â†’ ã‚·ãƒ§ãƒ¼ãƒˆ
            rev_target_1 := rev_base_price
            rev_target_2 := rev_base_price + rev_interval
            rev_target_3 := rev_base_price + rev_interval * 2
            
            // åˆ©ç¢ºãƒ»æåˆ‡ã‚Šä¾¡æ ¼ã‚’è¨­å®š
            avg_price = (rev_target_1 + rev_target_2 + rev_target_3) / 3
            rev_profit_target := avg_price - rev_profit
            rev_stop_target := rev_target_3 + rev_stop

// åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼å®Ÿè¡Œï¼ˆä¸¦åˆ—åˆ¤å®šï¼‰
if reversal_entered_this_session and not na(rev_target_1) and not reversal_trade_completed
    if is_up_window
        // ä¸Šçª“åŸ‹ã‚å¾Œ â†’ ãƒ­ãƒ³ã‚°
        if na(rev_entry_1) and low <= rev_target_1
            strategy.entry("rev_long_1", strategy.long, qty=1, comment="åè»¢1")
            rev_entry_1 := rev_target_1
            rev_position_count := rev_position_count + 1
            alert("ğŸ”¼åè»¢ãƒ­ãƒ³ã‚°1: " + str.tostring(rev_target_1) + "å†† (åŸºæº–" + str.tostring(rev_base_price) + "å††)", alert.freq_once_per_bar)
        
        if rev_num_entries >= 2 and na(rev_entry_2) and low <= rev_target_2
            strategy.entry("rev_long_2", strategy.long, qty=1, comment="åè»¢2")
            rev_entry_2 := rev_target_2
            rev_position_count := rev_position_count + 1
            alert("ğŸ”¼åè»¢ãƒ­ãƒ³ã‚°2: " + str.tostring(rev_target_2) + "å††", alert.freq_once_per_bar)
        
        if rev_num_entries >= 3 and na(rev_entry_3) and low <= rev_target_3
            strategy.entry("rev_long_3", strategy.long, qty=1, comment="åè»¢3")
            rev_entry_3 := rev_target_3
            rev_position_count := rev_position_count + 1
            alert("ğŸ”¼åè»¢ãƒ­ãƒ³ã‚°3: " + str.tostring(rev_target_3) + "å††", alert.freq_once_per_bar)
    else
        // ä¸‹çª“åŸ‹ã‚å¾Œ â†’ ã‚·ãƒ§ãƒ¼ãƒˆ
        if na(rev_entry_1) and high >= rev_target_1
            strategy.entry("rev_short_1", strategy.short, qty=1, comment="åè»¢1")
            rev_entry_1 := rev_target_1
            rev_position_count := rev_position_count + 1
            alert("ğŸ”½åè»¢ã‚·ãƒ§ãƒ¼ãƒˆ1: " + str.tostring(rev_target_1) + "å†† (åŸºæº–" + str.tostring(rev_base_price) + "å††)", alert.freq_once_per_bar)
        
        if rev_num_entries >= 2 and na(rev_entry_2) and high >= rev_target_2
            strategy.entry("rev_short_2", strategy.short, qty=1, comment="åè»¢2")
            rev_entry_2 := rev_target_2
            rev_position_count := rev_position_count + 1
            alert("ğŸ”½åè»¢ã‚·ãƒ§ãƒ¼ãƒˆ2: " + str.tostring(rev_target_2) + "å††", alert.freq_once_per_bar)
        
        if rev_num_entries >= 3 and na(rev_entry_3) and high >= rev_target_3
            strategy.entry("rev_short_3", strategy.short, qty=1, comment="åè»¢3")
            rev_entry_3 := rev_target_3
            rev_position_count := rev_position_count + 1
            alert("ğŸ”½åè»¢ã‚·ãƒ§ãƒ¼ãƒˆ3: " + str.tostring(rev_target_3) + "å††", alert.freq_once_per_bar)

// =====================================
// åè»¢ã®æ±ºæ¸ˆç®¡ç†
// =====================================

if rev_position_count > 0 and strategy.position_size != 0 and not na(rev_profit_target) and not na(rev_stop_target)
    // åˆ©ç¢ºåˆ¤å®š
    if is_up_window and high >= rev_profit_target
        strategy.close_all(comment="åè»¢åˆ©ç¢º")
        alert("âœ…åè»¢åˆ©ç¢º: " + str.tostring(rev_profit_target) + "å††", alert.freq_once_per_bar)
        rev_entry_1 := na
        rev_entry_2 := na
        rev_entry_3 := na
        rev_target_1 := na
        rev_target_2 := na
        rev_target_3 := na
        rev_position_count := 0
        rev_start_time := 0
        rev_base_price := na
        rev_profit_target := na
        rev_stop_target := na
        gap_filled := false
        reversal_trade_completed := true
    
    else if not is_up_window and low <= rev_profit_target
        strategy.close_all(comment="åè»¢åˆ©ç¢º")
        alert("âœ…åè»¢åˆ©ç¢º: " + str.tostring(rev_profit_target) + "å††", alert.freq_once_per_bar)
        rev_entry_1 := na
        rev_entry_2 := na
        rev_entry_3 := na
        rev_target_1 := na
        rev_target_2 := na
        rev_target_3 := na
        rev_position_count := 0
        rev_start_time := 0
        rev_base_price := na
        rev_profit_target := na
        rev_stop_target := na
        gap_filled := false
        reversal_trade_completed := true
    
    // æåˆ‡ã‚Šåˆ¤å®š
    else if is_up_window and low <= rev_stop_target
        strategy.close_all(comment="åè»¢æåˆ‡ã‚Š")
        alert("âŒåè»¢æåˆ‡ã‚Š: " + str.tostring(rev_stop_target) + "å††", alert.freq_once_per_bar)
        rev_entry_1 := na
        rev_entry_2 := na
        rev_entry_3 := na
        rev_target_1 := na
        rev_target_2 := na
        rev_target_3 := na
        rev_position_count := 0
        rev_start_time := 0
        rev_base_price := na
        rev_profit_target := na
        rev_stop_target := na
        gap_filled := false
        reversal_trade_completed := true
    
    else if not is_up_window and high >= rev_stop_target
        strategy.close_all(comment="åè»¢æåˆ‡ã‚Š")
        alert("âŒåè»¢æåˆ‡ã‚Š: " + str.tostring(rev_stop_target) + "å††", alert.freq_once_per_bar)
        rev_entry_1 := na
        rev_entry_2 := na
        rev_entry_3 := na
        rev_target_1 := na
        rev_target_2 := na
        rev_target_3 := na
        rev_position_count := 0
        rev_start_time := 0
        rev_base_price := na
        rev_profit_target := na
        rev_stop_target := na
        gap_filled := false
        reversal_trade_completed := true
    
    // 30åˆ†çµŒéã§ã®å¼·åˆ¶æ±ºæ¸ˆ
    else if (time - rev_start_time) >= rev_force_close_minutes * 60 * 1000
        strategy.close_all(comment="åè»¢30åˆ†å¼·åˆ¶æ±ºæ¸ˆ")
        alert("â°åè»¢å¼·åˆ¶æ±ºæ¸ˆ: 30åˆ†çµŒé", alert.freq_once_per_bar)
        rev_entry_1 := na
        rev_entry_2 := na
        rev_entry_3 := na
        rev_target_1 := na
        rev_target_2 := na
        rev_target_3 := na
        rev_position_count := 0
        rev_start_time := 0
        rev_base_price := na
        rev_profit_target := na
        rev_stop_target := na
        gap_filled := false
        reversal_trade_completed := true

// =====================================
// ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
// =====================================

// plotç”¨ã®è¡¨ç¤ºå¤‰æ•°ã‚’äº‹å‰è¨ˆç®—
show_base = show_lines and not na(base_price) ? base_price : na
show_gap_target_1 = show_lines and not na(gap_target_1) ? gap_target_1 : na
show_gap_target_2 = show_lines and not na(gap_target_2) ? gap_target_2 : na
show_gap_target_3 = show_lines and not na(gap_target_3) ? gap_target_3 : na
show_gap_profit = show_lines and not na(gap_profit_price) and gap_position_count > 0 ? gap_profit_price : na
show_gap_stop = show_lines and not na(gap_stop_price) and gap_position_count > 0 ? gap_stop_price : na
show_rev_target_1 = show_lines and not na(rev_target_1) ? rev_target_1 : na
show_rev_target_2 = show_lines and not na(rev_target_2) ? rev_target_2 : na
show_rev_target_3 = show_lines and not na(rev_target_3) ? rev_target_3 : na
show_rev_profit = show_lines and not na(rev_profit_target) and rev_position_count > 0 ? rev_profit_target : na
show_rev_stop = show_lines and not na(rev_stop_target) and rev_position_count > 0 ? rev_stop_target : na

// èƒŒæ™¯è‰²
bgcolor(show_background and in_stagnation ? color.new(color.blue, 95) : na)

// åŸºæº–ä¾¡æ ¼
plot(show_base, "åŸºæº–ä¾¡æ ¼", color=color.new(color.white, 0), linewidth=2)

// çª“åŸ‹ã‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ©ã‚¤ãƒ³
plot(show_gap_target_1, "çª“åŸ‹ã‚1", color=color.new(color.blue, 30), linewidth=1, style=plot.style_circles)
plot(show_gap_target_2, "çª“åŸ‹ã‚2", color=color.new(color.blue, 30), linewidth=1, style=plot.style_circles)
plot(show_gap_target_3, "çª“åŸ‹ã‚3", color=color.new(color.blue, 30), linewidth=1, style=plot.style_circles)

// çª“åŸ‹ã‚æ±ºæ¸ˆãƒ©ã‚¤ãƒ³
plot(show_gap_stop, "çª“åŸ‹ã‚æåˆ‡ã‚Š", color=color.new(color.red, 0), linewidth=2)
plot(show_gap_profit, "çª“åŸ‹ã‚åˆ©ç¢º", color=color.new(color.green, 0), linewidth=2)

// åè»¢ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ©ã‚¤ãƒ³
plot(show_rev_target_1, "åè»¢1", color=color.new(color.orange, 30), linewidth=1, style=plot.style_cross)
plot(show_rev_target_2, "åè»¢2", color=color.new(color.orange, 30), linewidth=1, style=plot.style_cross)
plot(show_rev_target_3, "åè»¢3", color=color.new(color.orange, 30), linewidth=1, style=plot.style_cross)

// åè»¢æ±ºæ¸ˆãƒ©ã‚¤ãƒ³
plot(show_rev_profit, "åè»¢åˆ©ç¢º", color=color.new(color.lime, 0), linewidth=2)
plot(show_rev_stop, "åè»¢æåˆ‡ã‚Š", color=color.new(color.maroon, 0), linewidth=2)

// ãƒ©ãƒ™ãƒ«è¡¨ç¤º
if show_labels and in_stagnation and not na(base_price) and stagnation_period != last_label_period
    period_text = stagnation_period == 1 ? "æœ" : (stagnation_period == 2 ? "æ˜¼" : "å¤•æ–¹")
    current_hour = get_jst_hour()
    current_minute = get_jst_minute()
    time_text = str.format("{0,number,00}:{1,number,00}", current_hour, current_minute)
    label.new(bar_index, high, period_text + "ã‚»ãƒƒã‚·ãƒ§ãƒ³\n" + time_text + " JST\nåŸºæº–: " + str.tostring(base_price), 
              style=label.style_label_down, 
              color=color.new(color.blue, 70), 
              textcolor=color.white, 
              size=size.small)
    last_label_period := stagnation_period
